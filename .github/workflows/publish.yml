name: Reusable Publish Workflow

on:
  workflow_call:

jobs:
  semantic-version:
      runs-on: ubuntu-latest
      steps:
        - name: Setup Environment
          uses: splunk-soar-connectors/.github/.github/actions/env-setup@main

        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: "lts/*"

        - name: Install dependencies
          run: |
            npm install --save-dev semantic-release
            npm install @semantic-release/changelog @semantic-release/git @semantic-release/exec -D

        - name: Run semantic-release and update version numbers
          env:
            GITHUB_TOKEN: ${{ secrets.SOAR_APPS_GITHUB_KEY }}
            DEBUG: semantic-release*
          run: |
            ls -lath
            pwd
            cat .releaserc.json
            npx semantic-release -e $(pwd)/.releaserc.json

  build:
    runs-on: ubuntu-latest
    needs: semantic-version
    steps:
      - name: Setup Environment
        uses: splunk-soar-connectors/.github/.github/actions/env-setup@main

      - name: Build Application
        uses: splunk-soar-connectors/.github/.github/actions/build-app@main

      - name: Upload app tar file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-tar
          path: ${{ github.event.repository.name }}.tgz

  publish:
    runs-on:
      - codebuild-integration-tests-${{ github.run_id }}-${{ github.run_attempt }}
      - image:custom-linux-875003031410.dkr.ecr.us-west-2.amazonaws.com/soar-connectors/pytest:f7150dbb7f347d35f8f4bb285d36985ecd4cf231
    needs: build
    permissions:
      contents: write # to be able to publish a GitHub release
    steps:
      - name: Check out app repo
        uses: actions/checkout@v4

      - name: Download app tar file for upload
        uses: actions/download-artifact@v4
        with:
          name: app-tar
          path: artifacts/

      - name: Publish
        uses: splunk-soar-connectors/.github/.github/actions/publish@mnordby/PAPP-35411
        env:
          UPLOAD_PATH: "artifacts/${{ github.event.repository.name }}.tgz"
